<!DOCTYPE html>
<html>
<head>
    <title>Mall Map Prototype</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"/>
    <link rel="stylesheet" href="css/mallMap.css"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://kit.fontawesome.com/c073ebcd4d.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/textures@1.2.0/dist/textures.js"></script>
    <script src="https://d3js.org/d3.v6.min.js" type="text/javascript"></script>
</head>
<body>
<div id="header_div">
    <div id="functional_div">
        <input type="radio" class="datasetChoice" name="datasetChoice" id="functional" value="functional" checked><label for="functional" style="font-weight: bold;">FUNCTIONAL</label>
    </div>
    <div id="group_div">
        <span style="font-weight: bold;">GROUPS</span><br><br>
    </div>
    <div id="well_div">
        <span style="font-weight: bold;">WELLS</span><br><br>
    </div>

</div>
<div id="breadcrumb_div"></div>
<div id="chart_div"></div>
<div id="extra_chart_div"></div>
<div id="footer_div"></div>
<div class="d3_tooltip" id="d3_tooltip_div"></div>


<script type="text/javascript" src="js/mallMap.js"></script>
<script type="text/javascript" src="js/mallMapReusables.js"></script>
<script type="text/javascript" src="js/mallMapProperties.js"></script>
<script>

    function downloadWellData(){
        console.log('downloading well data');
        var promises = [
        d3.json("https://prod-97.westus.logic.azure.com:443/workflows/909974398dd34ff3a28a0c468e54d2be/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=7gRYpMmX2thjblij6wfcbJMePRg9pFrr_Ppz-blAxbU",
            {method: "POST",body:JSON.stringify({client_id:1009,key_date:"2021-08-01",n:25}),headers:{"Content-Type":"application/json"}})
        ]
        Promise.all(promises).then(wellDataReady);

        function wellDataReady(all_datasets){

        }

    }
    var promises = [
        d3.json("https://prod-97.westus.logic.azure.com:443/workflows/909974398dd34ff3a28a0c468e54d2be/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=7gRYpMmX2thjblij6wfcbJMePRg9pFrr_Ppz-blAxbU",
            {method: "POST",body:JSON.stringify({client_id:1009,key_date:"2021-08-01",n:25}),headers:{"Content-Type":"application/json"}}),
        d3.json("https://prod-44.westus.logic.azure.com:443/workflows/f813d130506449c7aaf7e99e00776141/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=e-6x-Szn7DEoQDwAVwCSWmWXsJMFoQbMEV2VJbN6Suk"),
        d3.json("https://prod-129.westus.logic.azure.com:443/workflows/7f48f62137f54267a91e4b83687a2f83/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=F6ozaxNeplqKgzgQ7vgbV6_dKx97cHcLrKCxwB3eY1Y",
            {method: "POST",body:JSON.stringify({client_id:1009}),headers:{"Content-Type":"application/json"}}),
        d3.json("https://prod-177.westus.logic.azure.com:443/workflows/c5fcf01bfec54a25a6a7a5a41c981d35/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=K1iAuIu-VbhfketSSHWOe5hHt2AO_lx0N8z_ceSNXK8",
            {method: "POST",body:JSON.stringify({client_id:1009}),headers:{"Content-Type":"application/json"}}),
        d3.json("data/usStates.json"),
        d3.csv("data/stateCodes.csv"),
        d3.json("data/well_data.json"),
        d3.csv("data/ytd_production_data_min.csv")
    ]

    Promise.all(promises).then(ready)

    function ready(all_datasets) {

        var wellExtraData = {}
        var nodeIds = new Set();
        all_datasets[0].forEach(d => nodeIds.add(d.node_id));
        nodeIds = Array.from(nodeIds.values());
        nodeIds.forEach(function(n){
            wellExtraData[n] = all_datasets[0].filter(f => f.node_id === n);
            var totalDifference = d3.sum(wellExtraData[n],s => s.actual_revenue - s.ipc_revenue);
            wellExtraData[n].forEach(w => w.relativeDifference = (w.actual_revenue - w.ipc_revenue)/totalDifference)
        })

        mallMap.wellExtraData = wellExtraData;
        mallMap.wellData = all_datasets[6];
        mallMap.extraChartData = all_datasets[7];
        mallMap.extraChartData.map(m => m.date = convertDate(m.date))

        function convertDate(myDate){
            myDate = myDate.split("/");
            return new Date(myDate[2],+myDate[0]-1,myDate[1]);
        }
        wellNames = {};

        var colourMatrix = {}, matrixWellIds = new Set(), groupNames = new Set();
        var excludeKeys = ['client_id', 'well_id', 'well_or_group', 'name', 'well_count_for_reservoir','current_status','reservoir'];
        all_datasets[2].forEach(function(d){
            var myNodes = Object.keys(d).filter(f => excludeKeys.indexOf(f) === -1);
            myNodes.forEach(function(n){
                if(colourMatrix[n] === undefined){
                    colourMatrix[n] = [{"well_id":d.well_id,"color":d[n]}]
                } else {
                    colourMatrix[n].push({"well_id":d.well_id,"color":d[n]});
                }
                if(d.well_or_group === "group"){
                    groupNames.add(d.name);
                } else {
                    matrixWellIds.add(d.well_id);
                    wellNames[d.well_id] = d.name;
                }
            })
        })
        all_datasets[1] = all_datasets[1][0];
        all_datasets[1].colors = {"functional":"#F0F0F0"};
        all_datasets[1].children = addColour(all_datasets[1].children);

        function addColour(myChildren){
            myChildren.forEach(function(c){
                if(c.colors === undefined){
                    c.colors = {"functional":"#F0F0F0"};
                }
                if(colourMatrix[c.id] !== undefined){
                    colourMatrix[c.id].forEach(function(m){
                        c.colors[m.well_id] = m.color;
                    })
                }
                if(c.children !== undefined){
                    addColour(c.children);
                } else{
                    if (wellExtraData[c.id] !== undefined){
                        c.name = c.name.replace(/N/g,mallMap.myWellCount);
                        var extraChildren = [];
                        var groupColor = c.name.includes("Top") ? "green" : "red";
                        var sortType = groupColor === "green" ? "descending" : "ascending";
                        wellExtraData[c.id].forEach(function(w,i){
                            extraChildren.push({
                                "value":c.value/mallMap.myWellCount,
                                "name":w.well_name,
                                "relativeValue":c.value * w.relativeDifference,
                                "id": c.id + (i+1) + "-",
                                "difference":w.actual_revenue - w.ipc_revenue,
                                "group":c.name,
                                "group_color":groupColor,
                                "ipc": w.ipc_revenue,
                                "actual":w.actual_revenue,
                                "colors":{"functional":groupColor},
                                "node_level":c.node_level + 1,
                                "well_id":w.well_id
                            })
                        })
                        extraChildren = extraChildren.sort((a,b) =>
                        d3[sortType](a.relativeValue,b.relativeValue))
                        c.wellDataAdded = true;
                        c.children = extraChildren;
                    }
                }
            })
            return myChildren;
        }
        matrixWellIds = Array.from(matrixWellIds.values());
        groupNames = Array.from(groupNames.values());
        var wellsByGroup = {};
        groupNames.forEach(function(d){
            var myWells = all_datasets[3].find(f => f.group_name === d).wells;
            var myIds = [];
            myWells.forEach(f => myIds.push(f.well_id));
            wellsByGroup[d] = myIds;
        })

        var divGroup = d3.select("#group_div").selectAll('.groupDivInputs')
            .data(groupNames)
            .join(function(group){
                var enter = group.append("g").attr("class","groupDivInputs");
                enter.append("input").attr("class","groupInput");
                enter.append("span").attr("class","groupInputLabel");
                enter.append("br");
                return enter;
            });

        divGroup.select(".groupInput")
            .attr("id","group")
            .attr("y",(d,i) => (i*12))
            .attr("type","radio")
            .attr("class","datasetChoice")
            .attr("name","datasetChoice")
            .attr("value", d => d);

        divGroup.select(".groupInputLabel")
            .style("font-size","12px")
            .attr("x",30)
            .attr("y",(d,i) => (i*12))
            .html(d => d + " (" + wellsByGroup[d].length + ")");

        populateWells(matrixWellIds);

        function populateWells(myDataset){
            myDataset = myDataset.sort((a,b) => d3.ascending(wellNames[a],wellNames[b]))
            var wellGroup = d3.select("#well_div").selectAll('.wellDivInputs')
                .data(myDataset)
                .join(function(group){
                    var enter = group.append("g").attr("class","wellDivInputs");
                    enter.append("input").attr("class","wellInput");
                    enter.append("span").attr("class","wellInputLabel");
                    enter.append("br");
                    return enter;
                });

            wellGroup.select(".wellInput")
                .attr("id",d => "radio_" + d)
                .attr("y",(d,i) => (i*12))
                .attr("type","radio")
                .style("height","10px")
                .attr("class","datasetChoice")
                .attr("name","datasetChoice")
                .attr("value", d => d);

            wellGroup.select(".wellInputLabel")
                .style("font-size","10px")
                .attr("x",30)
                .attr("y",(d,i) => (i*12))
                .html(d => wellNames[d].substr(0,30));
        }


        mallMap.wellNames = wellNames;
        mallMap.mainData = all_datasets[1];
        mallMap.mapData = all_datasets[4];
        initialiseDashboard(mallMap.mainData,mallMap.mapData,"chart_div","breadcrumb_div","footer_div","extra_chart_div");
        downloadWellData();

        d3.selectAll(".datasetChoice")
            .on("change",function(d){
                if(this.id === "group"){
                    populateWells(wellsByGroup[this.value]);
                }
                mallMap.selectedColor = this.value;
                initialiseDashboard(mallMap.mainData, mallMap.mapData,"chart_div","breadcrumb_div","footer_div","extra_chart_div");
            });

    };

</script>
</body>
</html>
